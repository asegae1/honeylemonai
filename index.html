<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>HoneyLemonAI</title>
    <style>
        :root { --hl-yellow: #f1c40f; --bg: #fffef2; --panel: #ffffff; --text: #333; }
        [data-theme="black"] { --bg: #000; --panel: #1a1a1a; --text: #fff; }
        [data-theme="light"] { --bg: #f5f5f5; --panel: #fff; --text: #222; }

        body { font-family: sans-serif; margin: 0; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }
        
        /* サイドパネル */
        .sidebar { width: 300px; background: var(--panel); border-right: 2px solid var(--hl-yellow); padding: 20px; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; }
        .logo { font-size: 1.5rem; font-weight: 900; color: var(--hl-yellow); text-align: center; border-bottom: 3px solid var(--hl-yellow); padding-bottom: 10px; }
        
        .section { display: flex; flex-direction: column; gap: 8px; font-size: 0.85rem; }
        label { font-weight: bold; color: var(--hl-yellow); }
        select, input, textarea { padding: 8px; border: 1px solid #ddd; border-radius: 6px; background: var(--bg); color: var(--text); }

        /* チャットエリア */
        .main { flex: 1; display: flex; flex-direction: column; }
        #chat-window { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .msg { padding: 12px 16px; border-radius: 12px; max-width: 85%; line-height: 1.6; }
        .user { align-self: flex-end; background: var(--hl-yellow); color: white; }
        .ai { align-self: flex-start; background: var(--panel); border-left: 4px solid var(--hl-yellow); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }

        .input-box { padding: 20px; background: var(--panel); display: flex; gap: 10px; }
        textarea#userInput { flex: 1; height: 50px; resize: none; }
        button { background: var(--hl-yellow); color: white; border: none; border-radius: 8px; padding: 0 20px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="logo">HoneyLemonAI</div>
    
    <div class="section">
        <label>AIモデル</label>
        <select id="model">
            <option value="llama-3.1-8b-instant">nano (高速)</option>
            <option value="llama-3.3-70b-versatile" selected>Standard</option>
            <option value="llama-3.1-405b-reasoning">Pro (最強)</option>
        </select>
    </div>

    <div class="section">
        <label>性格設定</label>
        <textarea id="persona" placeholder="例: ツンデレなハニーレモン妖精として振る舞って。"></textarea>
    </div>

    <div class="section">
        <label>モード / 思考の深さ</label>
        <select id="mode">
            <option value="簡潔に、結論から答えて。">高速モード</option>
            <option value="論理的かつ親切に解説して。">自動モード</option>
            <option value="多角的な視点から、詳細な論文形式で考察して。">研究者モード</option>
        </select>
    </div>

    <div class="section">
        <label>最大レート（トークン数）: <span id="rateVal">500</span></label>
        <input type="range" id="rate" min="100" max="4000" step="100" value="500" oninput="rateVal.innerText=this.value">
    </div>

    <div class="section">
        <label>テーマ</label>
        <select id="theme" onchange="applyTheme(this.value)">
            <option value="system">システム同期</option>
            <option value="light">ライト</option>
            <option value="black">ブラック</option>
        </select>
    </div>

    <button onclick="clearHistory()" style="background:#e74c3c; padding:10px;">履歴をリセット</button>
</div>

<div class="main">
    <div id="chat-window"></div>
    <div class="input-box">
        <textarea id="userInput" placeholder="メッセージを入力..."></textarea>
        <button id="sendBtn" onclick="ask()">送信</button>
    </div>
</div>

<script>
    let history = JSON.parse(localStorage.getItem('HL_LOG')) || [];

    function init() {
        history.forEach(m => renderMsg(m.txt, m.type));
        applyTheme(localStorage.getItem('HL_THEME') || 'system');
    }

    function renderMsg(txt, type) {
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        div.innerText = txt;
        const win = document.getElementById('chat-window');
        win.appendChild(div);
        win.scrollTop = win.scrollHeight;
    }

    function applyTheme(t) {
        localStorage.setItem('HL_THEME', t);
        document.getElementById('theme').value = t;
        const dark = t === 'black' || (t === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches);
        document.documentElement.setAttribute('data-theme', dark ? 'black' : 'light');
    }

    async function ask() {
        const input = document.getElementById('userInput');
        const text = input.value.trim();
        if(!text || document.getElementById('sendBtn').disabled) return;

        renderMsg(text, 'user');
        history.push({txt: text, type: 'user'});
        input.value = '';

        const aiMsg = document.createElement('div');
        aiMsg.className = 'msg ai';
        aiMsg.innerText = "...";
        document.getElementById('chat-window').appendChild(aiMsg);
        
        document.getElementById('sendBtn').disabled = true;

        try {
            const res = await fetch('/api/chat', {
                method: 'POST',
                body: JSON.stringify({
                    prompt: text,
                    model: document.getElementById('model').value,
                    systemPrompt: `${document.getElementById('persona').value}\n${document.getElementById('mode').value}`,
                    maxTokens: document.getElementById('rate').value
                })
            });
            const data = await res.json();
            const reply = data.choices[0].message.content;
            aiMsg.innerText = reply;
            history.push({txt: reply, type: 'ai'});
            localStorage.setItem('HL_LOG', JSON.stringify(history));
        } catch (e) {
            aiMsg.innerText = "エラーが発生しました。設定を見直してください。";
        } finally {
            document.getElementById('sendBtn').disabled = false;
        }
    }

    function clearHistory() { if(confirm("消す？")) { localStorage.removeItem('HL_LOG'); location.reload(); } }
    init();
</script>
</body>
</html>
