<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>HoneyLemonAI</title>
    <style>
        /* CSS変数の定義（テーマ切り替え用） */
        :root {
            --hl-yellow: #f1c40f;
            --bg-color: #fffef2;
            --box-bg: #ffffff;
            --text-color: #333333;
            --border-color: #f9f0c3;
            --msg-user-bg: #f1c40f;
            --msg-ai-bg: #fdfdfd;
        }

        /* ブラックテーマ */
        [data-theme="black"] {
            --bg-color: #000000;
            --box-bg: #1a1a1a;
            --text-color: #ffffff;
            --border-color: #333333;
            --msg-user-bg: #444444;
            --msg-ai-bg: #222222;
        }

        /* ライトテーマ */
        [data-theme="light"] {
            --bg-color: #f5f5f5;
            --box-bg: #ffffff;
            --text-color: #222222;
            --border-color: #dddddd;
            --msg-user-bg: #007bff;
            --msg-ai-bg: #f8f9fa;
        }

        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: var(--bg-color); color: var(--text-color); transition: 0.3s; display: flex; flex-direction: column; height: 100vh; }

        /* ヘッダーとロゴ（CSSのみで装飾） */
        .header { padding: 20px; text-align: center; border-bottom: 2px solid var(--hl-yellow); background: var(--box-bg); }
        .logo { font-size: 2rem; font-weight: 900; color: var(--hl-yellow); display: inline-block; position: relative; }
        .logo::after { content: ""; position: absolute; bottom: -5px; left: 0; width: 100%; height: 4px; background: var(--hl-yellow); border-radius: 2px; }

        /* 設定パネル */
        .settings-bar { display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; background: var(--box-bg); border-bottom: 1px solid var(--border-color); justify-content: center; font-size: 0.8rem; }
        select { padding: 5px; border: 1px solid var(--border-color); border-radius: 5px; background: var(--box-bg); color: var(--text-color); }

        /* メインチャットエリア */
        #chat-window { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .msg { padding: 12px 18px; border-radius: 15px; max-width: 80%; line-height: 1.6; position: relative; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .user { align-self: flex-end; background: var(--msg-user-bg); color: white; border-bottom-right-radius: 2px; }
        .ai { align-self: flex-start; background: var(--msg-ai-bg); border-left: 5px solid var(--hl-yellow); color: var(--text-color); }

        /* 入力エリア */
        .footer { padding: 20px; background: var(--box-bg); border-top: 1px solid var(--border-color); }
        .input-group { display: flex; gap: 10px; max-width: 800px; margin: 0 auto; }
        textarea { flex: 1; height: 50px; border: 2px solid var(--border-color); border-radius: 10px; padding: 10px; background: var(--bg-color); color: var(--text-color); resize: none; outline: none; }
        button { background: var(--hl-yellow); color: white; border: none; border-radius: 10px; padding: 0 20px; cursor: pointer; font-weight: bold; }
        
        /* 履歴クリアボタン用のCSSアイコン */
        .btn-clear { background: #e74c3c; font-size: 0.7rem; padding: 5px 10px; }
    </style>
</head>
<body>

<div class="header"><div class="logo">HoneyLemonAI</div></div>

<div class="settings-bar">
    <select id="modelSelect">
        <option value="llama-3.1-8b-instant">HoneyLemonAI-nano</option>
        <option value="llama-3.3-70b-versatile" selected>HoneyLemonAI</option>
        <option value="llama-3.1-405b-reasoning">HoneyLemonAI Pro</option>
    </select>

    <select id="modeSelect">
        <option value="速く、簡潔に回答せよ。">モード：高速</option>
        <option value="丁寧かつ論理的に回答せよ。">モード：自動</option>
        <option value="専門的な研究者として、深い洞察と出典を意識して回答せよ。">モード：研究者</option>
    </select>

    <select id="themeSelect" onchange="changeTheme()">
        <option value="system">テーマ：システム</option>
        <option value="light">テーマ：ライト</option>
        <option value="black">テーマ：ブラック</option>
    </select>

    <button class="btn-clear" onclick="clearHistory()">履歴削除</button>
</div>

<div id="chat-window"></div>

<div class="footer">
    <div class="input-group">
        <textarea id="userInput" placeholder="メッセージを入力..."></textarea>
        <button id="sendBtn" onclick="ask()">送信</button>
    </div>
</div>

<script>
    // 履歴の読み込み
    let history = JSON.parse(localStorage.getItem('HL_HISTORY')) || [];

    function init() {
        renderHistory();
        applySavedTheme();
    }

    // メッセージの描画
    function addMsg(content, type, save = true) {
        const div = document.createElement('div');
        div.className = `msg ${type}`;
        div.innerText = content;
        document.getElementById('chat-window').appendChild(div);
        document.getElementById('chat-window').scrollTop = document.getElementById('chat-window').scrollHeight;
        
        if(save) {
            history.push({ content, type });
            localStorage.setItem('HL_HISTORY', JSON.stringify(history));
        }
        return div;
    }

    function renderHistory() {
        history.forEach(m => addMsg(m.content, m.type, false));
    }

    function clearHistory() {
        if(confirm("履歴を削除しますか？")) {
            localStorage.removeItem('HL_HISTORY');
            location.reload();
        }
    }

    // テーマ切り替え
    function changeTheme() {
        const theme = document.getElementById('themeSelect').value;
        localStorage.setItem('HL_THEME', theme);
        applySavedTheme();
    }

    function applySavedTheme() {
        const theme = localStorage.getItem('HL_THEME') || 'system';
        document.getElementById('themeSelect').value = theme;
        if(theme === 'system') {
            const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            document.documentElement.setAttribute('data-theme', isDark ? 'black' : 'light');
        } else {
            document.documentElement.setAttribute('data-theme', theme);
        }
    }

    // API通信
    async function ask() {
        const input = document.getElementById('userInput');
        const text = input.value.trim();
        if(!text) return;

        addMsg(text, 'user');
        input.value = '';
        const aiMsg = addMsg("...", 'ai', false);

        const model = document.getElementById('modelSelect').value;
        const modeDesc = document.getElementById('modeSelect').value;

        try {
            const res = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    prompt: `${modeDesc}\n\nUser: ${text}`,
                    model: model 
                })
            });
            const data = await res.json();
            const reply = data.choices[0].message.content;
            
            aiMsg.innerText = reply;
            // AIの返答を履歴に保存
            history.push({ content: reply, type: 'ai' });
            localStorage.setItem('HL_HISTORY', JSON.stringify(history));
        } catch (e) {
            aiMsg.innerText = "接続エラー。設定を確認してください。";
        }
    }

    init();
</script>
</body>
</html>
