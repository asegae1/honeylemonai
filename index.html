<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>honeylemonai</title>
  <link rel="icon" href="favicon.png" type="image/png">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <style>
    :root { --primary: #FFD700; --accent: #FFA500; --bg: #fffdf0; --white: #ffffff; }
    body { font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', Meiryo, sans-serif; background: var(--bg); margin: 0; display: flex; flex-direction: column; height: 100vh; color: #333; }
    
    /* Header & CSS Logo */
    .header { background: var(--white); padding: 12px 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; align-items: center; justify-content: space-between; z-index: 100; }
    .logo { font-weight: 900; font-size: 24px; background: linear-gradient(135deg, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; border-left: 6px solid var(--primary); padding-left: 15px; letter-spacing: -0.5px; }
    
    /* Chat Area */
    #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; scroll-behavior: smooth; }
    .msg { max-width: 80%; padding: 12px 18px; border-radius: 20px; font-size: 15px; line-height: 1.6; position: relative; word-wrap: break-word; }
    .user { align-self: flex-end; background: linear-gradient(135deg, var(--accent), #ff8c00); color: white; border-bottom-right-radius: 4px; box-shadow: 0 3px 10px rgba(255,165,0,0.2); }
    .ai { align-self: flex-start; background: var(--white); border: 1px solid #eee; border-bottom-left-radius: 4px; white-space: pre-wrap; box-shadow: 0 3px 10px rgba(0,0,0,0.02); }
    
    /* Result Styling */
    .img-result { width: 100%; max-width: 400px; border-radius: 12px; margin-top: 10px; border: 3px solid var(--primary); }
    .dl-link { display: inline-block; margin-top: 8px; padding: 6px 14px; background: #28a745; color: white; text-decoration: none; border-radius: 20px; font-size: 12px; font-weight: bold; }

    /* Input Area */
    .input-area { background: var(--white); padding: 15px 25px; border-top: 1px solid #eee; box-shadow: 0 -3px 10px rgba(0,0,0,0.02); }
    #preview-zone { font-size: 12px; color: var(--accent); margin-bottom: 8px; font-weight: bold; display: none; padding-left: 50px; }
    .controls { display: flex; gap: 10px; align-items: center; max-width: 1000px; margin: 0 auto; }
    
    .file-label { background: #f5f5f5; width: 42px; height: 42px; display: flex; align-items: center; justify-content: center; border-radius: 50%; cursor: pointer; font-size: 20px; transition: 0.2s; flex-shrink: 0; }
    .file-label:hover { background: #e8e8e8; }
    
    select { border: 2px solid #eee; border-radius: 15px; padding: 8px; outline: none; background: #fff; font-size: 13px; cursor: pointer; }
    input[type="text"] { flex: 1; padding: 12px 20px; border: 2px solid #eee; border-radius: 25px; outline: none; font-size: 15px; transition: 0.2s; }
    input[type="text"]:focus { border-color: var(--primary); }
    
    .send-btn { background: var(--primary); border: none; width: 42px; height: 42px; border-radius: 50%; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; box-shadow: 0 3px 8px rgba(255,215,0,0.3); }
    .send-btn:hover { transform: scale(1.05); background: var(--accent); }
    .send-btn:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; }
  </style>
</head>
<body>

<div class="header">
  <div class="logo">honeylemonai</div>
  <div id="status" style="font-size:10px; color:#999;">SYSTEM ONLINE</div>
</div>

<div id="chat-box"></div>

<div class="input-area">
  <div id="preview-zone"></div>
  <div class="controls">
    <label class="file-label">ğŸ“<input type="file" id="fileInput" style="display:none" onchange="handleFile()"></label>
    <select id="mode">
      <option value="chat">ä¼šè©±</option>
      <option value="image">ç”»åƒç”Ÿæˆ</option>
    </select>
    <input id="input" type="text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." autocomplete="off">
    <button class="send-btn" id="sendBtn" onclick="run()">ğŸ‹</button>
  </div>
</div>

<script>
  let currentFile = { name: "", data: "", text: "" };

  // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ï¼šã“ã“ã§ã€Œä¸­èº«ã€ã‚’ãƒ‡ãƒ¼ã‚¿åŒ–ã—ã¦ä¿æŒã™ã‚‹
  async function handleFile() {
    const file = document.getElementById('fileInput').files[0];
    if (!file) return;
    
    currentFile.name = file.name;
    const preview = document.getElementById('preview-zone');
    preview.style.display = "block";
    preview.innerText = `ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«å¾…æ©Ÿä¸­: ${file.name}`;

    // ç”»åƒã®å ´åˆï¼šBase64ã¨ã—ã¦èª­ã¿è¾¼ã‚€ï¼ˆGeminiç”¨ï¼‰
    if (file.type.startsWith('image/')) {
      const reader = new FileReader();
      reader.onload = (e) => { currentFile.data = e.target.result; };
      reader.readAsDataURL(file);
    } 
    // PDFã®å ´åˆï¼šPDF.jsã‚’ä½¿ã£ã¦ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡ºã™ã‚‹
    else if (file.type === 'application/pdf') {
      const arrayBuffer = await file.arrayBuffer();
      const pdfjsLib = window['pdfjs-dist/build/pdf'];
      pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
      const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
      let fullText = "";
      for(let i=1; i<=Math.min(pdf.numPages, 5); i++) { // æœ€å¤§5ãƒšãƒ¼ã‚¸
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        fullText += content.items.map(item => item.str).join(' ') + "\n";
      }
      currentFile.text = fullText;
    } 
    // ãã®ä»–ã®ãƒ†ã‚­ã‚¹ãƒˆï¼ˆtxt, cs, jsãªã©ï¼‰
    else {
      currentFile.text = await file.text();
    }
    preview.innerText = `âœ… æº–å‚™å®Œäº†: ${file.name}`;
  }

  async function run() {
    const input = document.getElementById('input');
    const mode = document.getElementById('mode').value;
    const btn = document.getElementById('sendBtn');
    
    if (!input.value && !currentFile.name) return;

    // ç”»é¢ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    addMsg(input.value || `${currentFile.name} ã‚’é€ä¿¡`, 'user');

    // é€ä¿¡ç”¨ãƒ‡ãƒ¼ã‚¿
    const payload = {
      prompt: input.value,
      image: currentFile.data,
      fileText: currentFile.text,
      fileName: currentFile.name
    };

    // UIãƒªã‚»ãƒƒãƒˆ
    input.value = "";
    document.getElementById('preview-zone').style.display = "none";
    btn.disabled = true;

    try {
      const endpoint = mode === 'image' ? '/api/image' : '/api/chat';
      const res = await fetch(endpoint, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const data = await res.json();
      
      if (mode === 'image' && data.image) {
        const div = document.createElement('div');
        div.className = 'msg ai';
        div.innerHTML = `<div>ç”»åƒã‚’ç”Ÿæˆã—ã¾ã—ãŸ:</div><img src="${data.image}" class="img-result"><br><a href="${data.image}" download="honeylemon_${Date.now()}.png" class="dl-link">ğŸ“¥ ä¿å­˜ã™ã‚‹</a>`;
        document.getElementById('chat-box').appendChild(div);
      } else {
        addMsg(data.content || data.error, 'ai');
      }
    } catch (e) {
      addMsg("é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚Vercelã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚", 'ai');
    } finally {
      btn.disabled = false;
      // çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
      currentFile = { name: "", data: "", text: "" };
      document.getElementById('fileInput').value = "";
      const b = document.getElementById('chat-box');
      b.scrollTop = b.scrollHeight;
    }
  }

  function addMsg(t, type) {
    const b = document.getElementById('chat-box');
    const d = document.createElement('div');
    d.className = `msg ${type}`;
    d.innerText = t;
    b.appendChild(d);
    b.scrollTop = b.scrollHeight;
  }

  // Enterã‚­ãƒ¼ã§é€ä¿¡
  document.getElementById('input').addEventListener('keypress', (e) => {
    if(e.key === 'Enter' && !document.getElementById('sendBtn').disabled) run();
  });
</script>
</body>
</html>
