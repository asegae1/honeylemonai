<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HoneyLemonAI Pro</title>
    <style>
        :root { --bg: #ffffff; --txt: #1f1f1f; --blue: #1a73e8; --lemon: #f1c40f; --side: #f8f9fa; --border: #ddd; }
        [data-theme="black"] { --bg: #131314; --txt: #e3e3e3; --side: #1e1f20; --border: #444; }
        body { font-family: sans-serif; margin: 0; display: flex; height: 100vh; background: var(--bg); color: var(--txt); transition: 0.3s; }
        
        .sidebar { width: 260px; background: var(--side); padding: 20px; border-right: 1px solid var(--border); display: flex; flex-direction: column; gap: 15px; }
        .logo { font-weight: bold; color: var(--lemon); font-size: 1.2rem; display: flex; align-items: center; gap: 8px; }
        textarea { width: 100%; height: 120px; background: var(--bg); color: var(--txt); border: 1px solid var(--border); border-radius: 8px; padding: 10px; resize: none; font-size: 0.9rem; }
        .btn-clear { background: #ea4335; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; margin-top: auto; font-weight: bold; }

        .main { flex: 1; display: flex; flex-direction: column; max-width: 1000px; margin: 0 auto; width: 100%; }
        #chat { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        .msg { line-height: 1.7; white-space: pre-wrap; padding: 12px 16px; border-radius: 12px; max-width: 85%; }
        .user { align-self: flex-end; background: var(--blue); color: white; }
        .ai { align-self: flex-start; background: var(--side); border: 1px solid var(--border); }
        .gen-img { width: 100%; max-width: 512px; border-radius: 12px; margin-top: 10px; display: block; border: 1px solid var(--border); }

        .input-area { padding: 20px; border-top: 1px solid var(--border); display: flex; gap: 10px; background: var(--bg); }
        #in { flex: 1; padding: 14px 20px; border-radius: 30px; border: 1px solid var(--border); outline: none; background: var(--side); color: var(--txt); font-size: 1rem; }
        .btn { padding: 0 20px; border-radius: 30px; cursor: pointer; border: none; font-weight: bold; transition: 0.2s; }
        .btn-text { background: var(--blue); color: #fff; }
        .btn-img { background: var(--lemon); color: #1f1f1f; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    </style>
</head>
<body>

<aside class="sidebar">
    <div class="logo">HoneyLemonAI Pro</div>
    <label style="font-size: 0.8rem; font-weight: bold;">AIプロンプト（思考の核）</label>
    <textarea id="persona">あなたは非常に優秀で論理的なAIアシスタントです。簡潔かつ正確に回答し、ユーザーの意図を深く汲み取ってください。メタ発言は禁止します。</textarea>
    
    <label style="font-size: 0.8rem; font-weight: bold;">テーマ</label>
    <select onchange="document.documentElement.setAttribute('data-theme', this.value)" style="padding: 8px; border-radius: 5px;">
        <option value="light">ライトモード</option>
        <option value="black">ダークモード</option>
    </select>

    <button class="btn-clear" onclick="clearChat()">履歴を消去</button>
</aside>

<main class="main">
    <div id="chat"></div>
    <div class="input-area">
        <input type="text" id="in" placeholder="質問、または画像のお題を入力..." onkeypress="if(event.key==='Enter')sendText()">
        <button class="btn btn-text" id="btnSend" onclick="sendText()">送信</button>
        <button class="btn btn-img" id="btnImg" onclick="fetchImage()">画像生成</button>
    </div>
</main>

<script>
    let isBusy = false;

    window.onload = () => {
        const saved = localStorage.getItem('hl_pro_final');
        if (saved) {
            document.getElementById('chat').innerHTML = saved;
            scroll();
        }
    };

    // AIをポンコツにしないための強力なシステムプロンプト
    const getSystemPrompt = () => {
        const userPersona = document.getElementById('persona').value;
        return `【絶対指示】
1. あなたは「HoneyLemonAI」という最高峰の知能を持つAIです。
2. 回答は常に論理的で、具体的に行ってください。
3. プロンプトの内容に言及する「メタ発言」は厳禁です。
4. 自然な日本語を用い、不自然な語尾は一切使用しないでください。
【現在の設定】
${userPersona}`;
    };

    async function sendText() {
        const input = document.getElementById('in');
        const text = input.value.trim();
        if (!text || isBusy) return;

        isBusy = true;
        toggleButtons(true);
        render(text, 'user');
        input.value = '';
        const aiMsg = render("...", 'ai');

        try {
            const res = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    prompt: text,
                    systemPrompt: getSystemPrompt()
                })
            });
            const data = await res.json();
            aiMsg.innerText = data.choices[0].message.content;
            save();
        } catch (e) {
            aiMsg.innerText = "通信エラーが発生しました。Vercelのログを確認してください。";
        } finally {
            isBusy = false;
            toggleButtons(false);
            scroll();
        }
    }

    async function fetchImage() {
        const input = document.getElementById('in');
        const text = input.value.trim();
        if (!text || isBusy) return;

        isBusy = true;
        toggleButtons(true);
        render(text + "（画像を生成中）", 'user');
        input.value = '';
        const aiMsg = render("AIが描画しています...", 'ai');

        // Vercel経由でPollinations AIを呼び出し
        const proxyUrl = `/api/image?prompt=${encodeURIComponent(text)}&t=${Date.now()}`;
        
        const img = document.createElement('img');
        img.className = 'gen-img';
        img.src = proxyUrl;

        img.onload = () => {
            aiMsg.innerText = "生成に成功しました：";
            aiMsg.appendChild(img);
            isBusy = false;
            toggleButtons(false);
            save();
            scroll();
        };

        img.onerror = () => {
            aiMsg.innerText = "生成エラーが発生しました。時間を置いて再度お試しください。";
            isBusy = false;
            toggleButtons(false);
        };
    }

    function render(t, type) {
        const d = document.createElement('div');
        d.className = `msg ${type}`;
        d.innerText = t;
        document.getElementById('chat').appendChild(d);
        scroll();
        return d;
    }

    function toggleButtons(state) {
        document.getElementById('btnSend').disabled = state;
        document.getElementById('btnImg').disabled = state;
    }

    function save() { localStorage.setItem('hl_pro_final', document.getElementById('chat').innerHTML); }
    function scroll() { const c = document.getElementById('chat'); c.scrollTop = c.scrollHeight; }
    function clearChat() { if(confirm("履歴を削除しますか？")){ localStorage.removeItem('hl_pro_final'); location.reload(); } }
</script>
</body>
</html>
