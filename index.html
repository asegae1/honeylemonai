<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>honeylemonai - Ultimate</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <style>
    /* åŸºæœ¬å¤‰æ•° (ãƒ©ã‚¤ãƒˆãƒ†ãƒ¼ãƒ) */
    :root { 
      --main: #FFD700; --accent: #FFA500; --bg: #fffdf0; --card: #ffffff; --txt: #333; 
      --ai-msg: #f9f9f9; --glass: rgba(255, 255, 255, 0.8);
    }
    /* ãƒ€ãƒ¼ã‚¯ãƒ†ãƒ¼ãƒ */
    body.dark { 
      --main: #ffcc00; --accent: #ff8c00; --bg: #121212; --card: #1e1e1e; --txt: #e0e0e0; 
      --ai-msg: #2a2a2a; --glass: rgba(30, 30, 30, 0.8);
    }

    body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--txt); margin: 0; height: 100vh; display: flex; flex-direction: column; transition: 0.3s; }
    
    /* Header */
    .header { background: var(--glass); backdrop-filter: blur(10px); padding: 15px 25px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(0,0,0,0.1); }
    .logo { font-weight: 900; font-size: 22px; background: linear-gradient(135deg, var(--main), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    
    /* Settings Bar */
    .settings-bar { display: flex; gap: 10px; padding: 10px 25px; background: rgba(0,0,0,0.03); font-size: 12px; overflow-x: auto; }
    
    /* Chat Area */
    #chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
    .msg { max-width: 80%; padding: 12px 18px; border-radius: 20px; font-size: 14px; line-height: 1.6; }
    .user { align-self: flex-end; background: linear-gradient(135deg, var(--main), var(--accent)); color: #fff; }
    .ai { align-self: flex-start; background: var(--ai-msg); border: 1px solid rgba(0,0,0,0.05); white-space: pre-wrap; }

    /* Input */
    .input-area { background: var(--card); padding: 20px; border-top: 1px solid rgba(0,0,0,0.1); }
    .controls { display: flex; gap: 10px; align-items: center; max-width: 1000px; margin: 0 auto; }
    input[type="text"] { flex: 1; padding: 12px 20px; border: 2px solid rgba(0,0,0,0.1); border-radius: 25px; background: var(--bg); color: var(--txt); outline: none; }
    
    .btn-lemon { background: var(--main); border: none; width: 45px; height: 45px; border-radius: 50%; cursor: pointer; font-size: 20px; transition: 0.3s; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
    .btn-lemon:disabled { filter: grayscale(1); opacity: 0.5; cursor: not-allowed; }

    .rate-limit { font-size: 10px; color: var(--accent); margin-top: 5px; text-align: center; }
  </style>
</head>
<body class="light">

<div class="header">
  <div class="logo">honeylemonai</div>
  <div style="display: flex; gap: 10px;">
    <button onclick="toggleTheme()" style="background:none; border:none; cursor:pointer; font-size:20px;">ğŸŒ“</button>
  </div>
</div>

<div class="settings-bar">
  <select id="personality" onchange="updatePersonality()">
    <option value="friendly">æ€§æ ¼: ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ ğŸ‹</option>
    <option value="cool">æ€§æ ¼: ã‚¯ãƒ¼ãƒ« ğŸ§Š</option>
    <option value="tsundere">æ€§æ ¼: ãƒ„ãƒ³ãƒ‡ãƒ¬ ğŸ”¥</option>
    <option value="expert">æ€§æ ¼: å°‚é–€å®¶ ğŸ“</option>
  </select>
  <select id="mode">
    <option value="chat">ãƒ¢ãƒ¼ãƒ‰: ä¼šè©±</option>
    <option value="image">ãƒ¢ãƒ¼ãƒ‰: ç”»åƒç”Ÿæˆ</option>
  </select>
  <div id="rate-display">ç”»åƒæ : 4/4</div>
</div>

<div id="chat-box"></div>

<div class="input-area">
  <div class="controls">
    <label style="cursor:pointer; font-size:22px;">ğŸ“<input type="file" id="fileInput" style="display:none" onchange="handleFile()"></label>
    <input id="input" type="text" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." onkeypress="if(event.key==='Enter') run()">
    <button class="btn-lemon" id="sendBtn" onclick="run()">ğŸ‹</button>
  </div>
  <div class="rate-limit" id="cooldown-text"></div>
</div>

<script>
  let imageCount = 4;
  let cooldown = false;
  let currentFile = { name: "", data: "", text: "" };

  function toggleTheme() {
    document.body.classList.toggle('dark');
  }

  // ç”»åƒç”Ÿæˆã®å›æ•°åˆ¶é™ãƒ­ã‚¸ãƒƒã‚¯ (1åˆ†é–“ã«4å›)
  function checkImageRate() {
    if (imageCount <= 0) {
      cooldown = true;
      document.getElementById('sendBtn').disabled = true;
      let seconds = 60;
      const timer = setInterval(() => {
        seconds--;
        document.getElementById('cooldown-text').innerText = `ç”»åƒç”Ÿæˆåˆ¶é™ä¸­... ã‚ã¨ ${seconds}ç§’`;
        if (seconds <= 0) {
          clearInterval(timer);
          imageCount = 4;
          cooldown = false;
          document.getElementById('sendBtn').disabled = false;
          document.getElementById('cooldown-text').innerText = "";
          updateRateDisplay();
        }
      }, 1000);
      return false;
    }
    imageCount--;
    updateRateDisplay();
    return true;
  }

  function updateRateDisplay() {
    document.getElementById('rate-display').innerText = `ç”»åƒæ : ${imageCount}/4`;
  }

  async function handleFile() {
    const file = document.getElementById('fileInput').files[0];
    if (!file) return;
    addMsg(`File: ${file.name} ã‚’èª­ã¿è¾¼ã¿ä¸­...`, 'ai');
    // ... å‰å›ã®PDF/ç”»åƒèª­ã¿å–ã‚Šãƒ­ã‚¸ãƒƒã‚¯ ...
  }

  async function run() {
    const input = document.getElementById('input');
    const mode = document.getElementById('mode').value;
    const personality = document.getElementById('personality').value;
    
    if (!input.value && !currentFile.name) return;
    if (mode === 'image' && !checkImageRate()) return;

    addMsg(input.value, 'user');
    const userText = input.value;
    input.value = "";

    try {
      const res = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
          prompt: userText, 
          image: currentFile.data, 
          fileText: currentFile.text,
          personality: personality,
          mode: mode
        })
      });
      const data = await res.json();
      addMsg(data.content, 'ai');
    } catch (e) {
      addMsg("Connection Error. åˆ¶é™è§£é™¤ã‚’å¾…ã£ã¦ãã ã•ã„ã€‚", 'ai');
    }
  }

  function addMsg(t, type) {
    const b = document.getElementById('chat-box');
    const d = document.createElement('div');
    d.className = `msg ${type}`; d.innerText = t;
    b.appendChild(d); b.scrollTop = b.scrollHeight;
  }
</script>
</body>
</html>
